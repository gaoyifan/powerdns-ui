services:
  pdns:
    container_name: pdns-server
    image: ${PDNS_IMAGE:-powerdns/pdns-auth-50}:${PDNS_TAG:-5.0.2}
    user: root
    restart: unless-stopped
    network_mode: ${PDNS_NETWORK_MODE:-}
    ports:
      - "8081:8081"
      - "53:53/udp"
    # Note: networks and ports are ignored if network_mode is 'host'
    volumes:
      - pdns-data:/var/lib/powerdns
      - ./pdns.conf:/etc/powerdns/pdns.conf:ro
      - ./deploy/zones:/zones:ro
    command: [ "--api-key=${PDNS_API_KEY:-secret}" ]
    healthcheck:
      test: [ "CMD-SHELL", "pdns_control rping >/dev/null 2>&1 || exit 1" ]
      interval: 2s
      timeout: 2s
      retries: 30

  ui:
    build: .
    environment:
      - API_UPSTREAM=${API_UPSTREAM:-pdns:8081}
    ports:
      - "8080:80"
    depends_on:
      pdns:
        condition: service_healthy
    restart: unless-stopped

volumes:
  pdns-data:
